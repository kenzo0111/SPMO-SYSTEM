<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>SPMO Access System</title>
  <link rel="stylesheet" href="../assets/css/AccessSystem.css" />
</head>

<body>
  <header>
    <div class="header-container">
      <div class="logo">
        <img src="../assets/images/cnscrefine.png" alt="CNSC Logo" />
        <div class="logo-text">
          <h1>Supply and Property Management</h1>
          <hr />
          <p>WEB-BASED INVENTORY AND PROCUREMENT MANAGEMENT SYSTEM</p>
        </div>
      </div>
    </div>
  </header>

  <main class="access-main">
    <div class="access-container">
      <div class="access-content">
        <div class="login-badge">
          <span>One CNSC, One Goal</span>
        </div>

        <form class="login-card" onsubmit="handleLogin(event)">
          <div class="login-header">
            <h2>Welcome Back</h2>
            <div class="login-subtitle">Sign in to access your account</div>
          </div>

          <div class="form-group">
            <label class="form-label" for="email">Email Address</label>
            <input class="form-input" id="email" name="email" type="email" placeholder="cnsc.spmo@edu.ph" required />
          </div>

          <div class="form-group">
            <label class="form-label">Security PIN</label>
            <div class="otp-container" id="otp">
              <input type="password" inputmode="numeric" maxlength="1" aria-label="Digit 1">
              <input type="password" inputmode="numeric" maxlength="1" aria-label="Digit 2">
              <input type="password" inputmode="numeric" maxlength="1" aria-label="Digit 3">
              <input type="password" inputmode="numeric" maxlength="1" aria-label="Digit 4">
              <input type="password" inputmode="numeric" maxlength="1" aria-label="Digit 5">
              <input type="password" inputmode="numeric" maxlength="1" aria-label="Digit 6">
            </div>
          </div>

          <div class="form-extras">
            <a href="#" class="forgot-link">Forgot your PIN?</a>
          </div>

          <input type="hidden" name="credentials" id="hiddenPin" />

          <button class="login-btn" type="submit">
            <span class="btn-text">Sign In</span>
            <span class="btn-icon">â†’</span>
          </button>
        </form>
      </div>
    </div>
  </main>

  <script>
    // Lightweight showAlert fallback for standalone pages
    function showAlert(message, type = 'info', duration = 3500) {
      try {
        let container = document.getElementById('ui-alert-container');
        if (!container) {
          container = document.createElement('div');
          container.id = 'ui-alert-container';
          document.body.appendChild(container);
        }
        const el = document.createElement('div');
        el.className = `ui-alert ui-alert-${type}`;
        el.textContent = message;
        container.appendChild(el);
        setTimeout(() => { el.remove(); }, duration);
      } catch (e) { alert(message); }
    }

    // OTP / PIN behavior (Updated for new class names)
    const otpInputs = Array.from(document.querySelectorAll('.otp-container input'));
    const hiddenPin = document.getElementById('hiddenPin');
    const emailInput = document.getElementById('email');

    const setHidden = () => hiddenPin.value = otpInputs.map(i => i.value).join('');

    otpInputs.forEach((input, idx) => {
      input.addEventListener('input', () => {
        input.value = input.value.replace(/[^0-9]/g, '').slice(0, 1);
        if (input.value && idx < otpInputs.length - 1) otpInputs[idx + 1].focus();
        setHidden();
      });

      input.addEventListener('keydown', (e) => {
        if (e.key === 'Backspace' && !input.value && idx > 0) otpInputs[idx - 1].focus();
        if (e.key === 'ArrowLeft' && idx > 0) otpInputs[idx - 1].focus();
        if (e.key === 'ArrowRight' && idx < otpInputs.length - 1) otpInputs[idx + 1].focus();
      });

      input.addEventListener('paste', (e) => {
        e.preventDefault();
        const digits = (e.clipboardData.getData('text') || '').replace(/\D/g, '').slice(0, otpInputs.length).split('');
        otpInputs.forEach((box, i) => box.value = digits[i] || '');
        const next = digits.length >= otpInputs.length ? otpInputs[otpInputs.length - 1] : otpInputs[digits.length] || otpInputs[0];
        next.focus(); setHidden();
      });
    });

    function handleLogin(event) {
      // Prevent the form from doing a traditional page reload submission
      event.preventDefault();

      const userEmail = emailInput.value;
      const userPin = hiddenPin.value;

      // Basic validation: Check if all 6 PIN digits are entered
      if (userPin.length !== 6) {
        // Show modal alert dialog (fallbacks to native alert if not supported)
        showAlertDialog("Please enter all 6 digits of your credentials.");
        otpInputs[0].focus(); // Focus on the first PIN box
        return; // Stop the login process
      }

      // --- In a real application, you would send userEmail and userPin to a server here ---
      // Show a modal dialog that confirms the attempted login instead of logging to the console
      showLoginDialog(userEmail, userPin);
    }
  </script>
  <!-- Login confirmation dialog -->
  <dialog id="loginDialog" class="login-dialog">
    <form method="dialog">
      <h3>Confirm Sign in</h3>
      <p id="dialogText">Checking...</p>
      <menu>
        <button id="cancelBtn" type="submit" value="cancel">Cancel</button>
        <button id="confirmBtn" type="submit" value="confirm">Continue</button>
      </menu>
    </form>
  </dialog>

  <!-- Simple alert dialog used for validation messages -->
  <dialog id="alertDialog" class="login-dialog" aria-live="polite">
    <form method="dialog">
      <h3>Attention</h3>
      <p id="alertText">Message</p>
      <menu>
        <button id="alertOk" type="submit" value="ok">OK</button>
      </menu>
    </form>
  </dialog>

  <script>
    // Mask the PIN for display (show only last 2 digits)
    function maskPin(pin) {
      if (!pin) return '';
      if (pin.length <= 2) return '*'.repeat(pin.length);
      return '*'.repeat(pin.length - 2) + pin.slice(-2);
    }

    function showLoginDialog(email, pin) {
      const dialog = document.getElementById('loginDialog');
      const text = document.getElementById('dialogText');
      const masked = maskPin(pin);
      text.textContent = `Sign in as ${email} with PIN ${masked}?`;

      if (typeof dialog.showModal === 'function') {
        dialog.showModal();
        // Wire buttons
        const confirm = document.getElementById('confirmBtn');
        const cancel = document.getElementById('cancelBtn');

        function onClose(e) {
          // value is provided by <menu> button values
          const val = dialog.returnValue;
          dialog.removeEventListener('close', onClose);
          if (val === 'confirm') {
            // proceed to dashboard
            window.location.href = 'admin/dashboard.html';
          } else {
            // allow user to edit PIN/email
            otpInputs[0].focus();
          }
        }

        dialog.addEventListener('close', onClose);
      } else {
        // Fallback: use confirm() dialog
        const ok = confirm(`Sign in as ${email} with PIN ${masked}?`);
        if (ok) window.location.href = 'admin/dashboard.html';
        else otpInputs[0].focus();
      }
    }

    // Show a simple alert dialog. Uses <dialog> if available, otherwise window.alert
    function showAlertDialog(message) {
      const ad = document.getElementById('alertDialog');
      const text = document.getElementById('alertText');
      text.textContent = message;
      if (typeof ad.showModal === 'function') {
        ad.showModal();
        // focus OK button for accessibility
        const ok = document.getElementById('alertOk');
        ok.focus();
        ad.addEventListener('close', function onClose() {
          ad.removeEventListener('close', onClose);
        });
      } else {
        alert(message);
      }
    }
  </script>
</body>

</html>